name: Build Excel with vbapm

on:
  workflow_dispatch:
  push:
    branches:
      - dev-vbapm
    paths:
      - ".github/workflows/vbapm_build.yml"

jobs:
  build-xlsm:
    runs-on: windows-2025

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Prepare Office apps
        uses: ./
        with:
          office-apps: Excel

      - name: Install vbapm
        shell: pwsh
        run: |
          npm install --no-save vbapm@0.6.3-alpha

      - name: Patch vbapm Windows script
        shell: pwsh
        run: |
          $path = "node_modules/vbapm/run-scripts/run.ps1"
          $content = Get-Content -Path $path -Raw
          $content = $content.Replace('$UnescapedArgs += Unescape $arg', '$UnescapedArgs += ($arg -replace ''\^q'', ''"'')')
          Set-Content -Path $path -Value $content

      - name: Initialize sample vbapm project
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path vbapm-sample -Force | Out-Null
          Set-Location vbapm-sample
          npx vbapm init --target xlsm --name ci-build --no-git

      - name: Build xlsm target
        shell: pwsh
        run: |
          Set-Location vbapm-sample
          npx vbapm build --target xlsm

      - name: Collect built workbook
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          $files = Get-ChildItem -Path vbapm-sample -Recurse -Filter *.xlsm -File
          foreach ($file in $files) {
            Copy-Item -Path $file.FullName -Destination artifacts -Force
            Write-Host "Collected $($file.FullName)"
          }

          if (-not (Test-Path "artifacts\*.xlsm")) {
            throw "No .xlsm files were produced by vbapm build."
          }

      - name: Upload workbook artifact
        uses: actions/upload-artifact@v4
        with:
          name: vbapm-xlsm
          path: artifacts/*.xlsm